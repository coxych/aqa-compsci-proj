<%- include('partials/header'); -%>
<header>
    <h2>HERE YOU CAN MANAGE YOUR INCOMES</h2>
</header>
<h2>Your current budget = <%= user.budget %> £</h2>
<h3>You can add your income here</h3>
<div class="row-layout">
  <br>
<br>
<form action="/income" method="post">
  <label for="amount">Amount</label>
  <input type="number" step="0.01" name="amount" required>
  <label for="date">Date</label>
  <input type="date" name="date" value="<%= new Date().toISOString().split('T')[0] %>" required>
  <label for="category">Category</label>
  <input type="text" name="category" required>
  <label for="description">Description (optional)</label>
  <input type="text" name="description" >
  <% if (user.goals.length > 0){ %>
    <label for="forgoal">Percentage of income to goal (optional)</label>
    <input type="number" min="1" max="100" name="percentage"/>
  <% } %>
  <button class="btn" type="submit">Add</button>
</form>
<script>
  const form = document.querySelector('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const amount = form.amount.value;
    const date = form.date.value;
    const category = form.category.value;
    const description = form.description.value;
    console.log(description)
    let percentage = 0;
    if (form.percentage) {
      percentage = form.percentage.value;
    }
    try {
      const res = await fetch('/income', {
        method: 'POST',
        body: JSON.stringify({ amount, date, category, description, percentage }),
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      if (data) {
        location.assign('/income');
      }
    } catch (err) {
      console.log(err.message);
    }
  });
</script>
<div class="scroll-gr">
  <h2>Your 6 latest incomes:</h2>
  <% for (let i = 0; i < 6 && i < user.incomes.length; i++) { %>
  <li>
    <p>Amount: <%= user.incomes[user.incomes.length - 1 - i].amount %> £</p>
    <p>Date: <%= user.incomes[user.incomes.length - 1 - i].date %></p>
    <p>Category: <%= user.incomes[user.incomes.length - 1 - i].category %></p>
    <% if (user.incomes[user.incomes.length - 1 - i].description){ %>
      <p>Description: <%= user.incomes[user.incomes.length - 1 - i].description %></p>
    <% } else {%>
      <p></p>
    <% } %>
  </li>
  <% } %>
</div>
</div>
<br>
<h2>ADD YOUR SALARY OR USUAL PROFIT HERE:</h2>
<br>
<div class="row-layout">
<form action="/addsalary" method="post">
  <label for="amount">Amount</label>
  <input type="number" step="0.01" name="amount" required>
  <label for="howoften">How often</label>
  <select name="howoften" id="howoften">
    <option value="daily">Daily</option>
    <option value="weekly">Weekly</option>
    <option value="monthly">Monthly</option>
  </select>
  <label for="date">Next date of payment</label>
  <input type="date" name="date" value="<%= new Date().toISOString().split('T')[0] %>" required>
  <label for="category">Category</label>
  <input type="text" name="category" required>
  <label for="description">Description (optional)</label>
  <input type="text" name="description" >
  <button class="btn" type="submit">Add</button>
</form>
<script>
  const form2 = document.querySelector('form');
  form2.addEventListener('submit', async (e) => {
    e.preventDefault();
    const amount = form2.amount.value;
    const date = form2.date.value;
    const howoften = form2.howoften.value;
    const category = form2.category.value;
    const description = form2.description.value;
    try {
        fetch('/addsalary', {
        method: 'POST',
        body: JSON.stringify({ amount, date, category, description, }),
        headers: { 'Content-Type': 'application/json' }
      })
    } 
    catch (err) {
      console.log(err.message);
    }
  });
</script>
<div data-user-id="<%= user._id %>" class="scroll-gr">
  <h2>All your constant income sources so far</h2>
  <% user.salaries.reverse().forEach((salary) => { %>
    <div class="row-layout">
      <li>
        <p>Amount: <%= salary.amount %> £</p>
        <p>Next date: <%= salary.date %></p>
        <p>Category: <%= salary.category %></p>
        <p>How Often: <%= salary.howoften %></p>
        <% if (salary.description){ %>
          <p>Description: <%= salary.description %></p>
        <% } else {%>
          <p></p>
        <% } %>
        <button class="btn delete-btn" data-id="<%= salary.id%>" data-usid="<%= user._id %>">DELETE</button>
      </li>
    </div>
  <% }); %>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', function() {
        const salaryId = this.getAttribute('data-id');
        const userId = this.getAttribute('data-usid');
        try {
          fetch(`/user/${userId}/salary/${salaryId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(() => {
            location.reload();
          });
        } catch {
          console.log('failed to delete salary');
        }
      });
    });
  });
</script>


</div>



<%- include('partials/footer'); -%>